<div class="replenishment-page">
  <div class="page-header">
    <h1 class="title is-3 has-text-primary">R√©approvisionnement</h1>
    <p class="subtitle is-6 has-text-grey">Cr√©ez et suivez vos demandes de r√©appro</p>
  </div>

  <div class="columns is-multiline mb-6">
    <div class="column is-3">
      <div class="card metric-card">
        <div class="card-content">
          <div class="level">
            <div class="level-left">
              <div>
                <p class="heading">Demandes en Attente</p>
                <p class="title is-4 has-text-warning">{{ metrics.pending_requests_count }}</p>
                <p class="subtitle is-7">En cours de validation</p>
              </div>
            </div>
            <div class="level-right">
              <span class="icon is-large has-text-warning">
                <span class="emoji">‚è≥</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="column is-3">
      <div class="card metric-card">
        <div class="card-content">
          <div class="level">
            <div class="level-left">
              <div>
                <p class="heading">Derni√®re Livraison</p>
                <p class="title is-5 has-text-success">{{ metrics.last_approved_request_date || 'N/A' }}</p>
                <p class="subtitle is-7 has-text-success">{{ metrics.last_approved_request_quantity || 0 }} produits re√ßus</p>
              </div>
            </div>
            <div class="level-right">
              <span class="icon is-large has-text-success">
                <span class="emoji">üì¶</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="column is-3">
      <div class="card metric-card critical">
        <div class="card-content">
          <div class="level">
            <div class="level-left">
              <div>
                <p class="heading">Produits Urgents</p>
                <p class="title is-4 has-text-danger">{{ metrics.critical_products_count }}</p>
                <p class="subtitle is-7 has-text-danger">Stock < 5</p>
              </div>
            </div>
            <div class="level-right">
              <span class="icon is-large has-text-danger">
                <span class="emoji">üö®</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="column is-3">
      <div class="card metric-card">
        <div class="card-content">
          <div class="level">
            <div class="level-left">
              <div>
                <p class="heading">Prochaine Livraison</p>
                <p class="title is-5 has-text-info">√Ä d√©finir</p>
                <p class="subtitle is-7">Pr√©visionnel</p>
              </div>
            </div>
            <div class="level-right">
              <span class="icon is-large has-text-info">
                <span class="emoji">üöõ</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="action-buttons mb-6">
    <button class="button is-primary is-medium" (click)="openQuickReplenishModal()">
      <span class="icon">
        <span class="emoji">‚ö°</span>
      </span>
      <span>Demande Rapide</span>
    </button>
  </div>

  <div class="form-section mb-6">
    <app-replenishment-form [urgentProducts]="urgentProducts" (onRequestSubmit)="onNewReplenishmentRequest($event)"></app-replenishment-form>
  </div>

  <div class="requests-history">
    <div class="card">
      <div class="card-header">
        <p class="card-header-title">
          <span class="icon mr-2">
            <span class="emoji">üìã</span>
          </span>
          Historique des Demandes
        </p>
      </div>
      <div class="card-content p-0">
        <div class="table-container">
          <table class="table is-fullwidth is-hoverable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Priorit√©</th>
                <th>Statut</th>
                <th>Articles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="requests.length === 0">
                <td colspan="6" class="has-text-centered">Aucune demande trouv√©e</td>
              </tr>
              <tr *ngFor="let request of requests">
                <td>{{ request.id }}</td>
                <td>{{ formatDate(request.created_at) }}</td>
                <td>
                  <span class="tag" [ngClass]="getPriorityClass(request.priority)">
                    {{ getPriorityText(request.priority) }}
                  </span>
                </td>
                <td>
                  <span class="tag" [ngClass]="getStatusClass(request.status)">
                    {{ getStatusText(request.status) }}
                  </span>
                </td>
                <td>{{ request.totalQuantity }} articles</td>
                <td class="action-buttons">
                  <button class="button is-small is-info is-light" (click)="openDetailsModal(request)">
                    <span class="icon is-small">
                      <span class="emoji">üëÄ</span>
                    </span>
                  </button>
                  <button
                    class="button is-small is-warning is-light"
                    *ngIf="request.status === 'en_attente'"
                    (click)="openEditModal(request)">
                    <span class="icon is-small">
                      <span class="emoji">üìù</span>
                    </span>
                  </button>
                  <button
                    class="button is-small is-danger is-light"
                    *ngIf="request.status === 'en_attente'"
                    (click)="cancelRequest(request.id)">
                    <span class="icon is-small">
                      <span class="emoji">‚ùå</span>
                    </span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" [ngClass]="{'is-active': showDetailsModal}">
    <div class="modal-background" (click)="closeDetailsModal()"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">D√©tails de la demande {{ selectedRequest?.id }}</p>
        <button class="delete" aria-label="close" (click)="closeDetailsModal()"></button>
      </header>
      <section class="modal-card-body" *ngIf="selectedRequest">
        <p><strong>Date de la demande:</strong> {{ formatDateTime(selectedRequest.created_at) }}</p>
        <p><strong>Statut:</strong> <span class="tag" [ngClass]="getStatusClass(selectedRequest.status)">{{ getStatusText(selectedRequest.status) }}</span></p>
        <p><strong>Priorit√©:</strong> <span class="tag" [ngClass]="getPriorityClass(selectedRequest.priority)">{{ getPriorityText(selectedRequest.priority) }}</span></p>
        <p><strong>Commentaire:</strong> {{ selectedRequest.comment || 'N/A' }}</p>
        <br>
        <h4 class="title is-5">Produits demand√©s :</h4>
        <ul>
          <li *ngFor="let item of selectedRequest.items">
            - {{ item.product }}: {{ item.quantity }}
          </li>
        </ul>
      </section>
      <footer class="modal-card-foot">
        <button class="button" (click)="closeDetailsModal()">Fermer</button>
      </footer>
    </div>
  </div>

  <div class="modal" [ngClass]="{'is-active': showEditModal}">
    <div class="modal-background" (click)="closeEditModal()"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Modifier la demande {{ editedRequest?.id }}</p>
        <button class="delete" aria-label="close" (click)="closeEditModal()"></button>
      </header>
      <section class="modal-card-body" *ngIf="editedRequest">
        <form (ngSubmit)="onEditSubmit()">
          <div class="field">
            <label class="label">Priorit√©</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="priority" [(ngModel)]="editedRequest.priority">
                  <option value="normal">Normale</option>
                  <option value="urgent">Urgente</option>
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label">Commentaire</label>
            <div class="control">
              <textarea
                class="textarea"
                name="comment"
                placeholder="Ajouter un commentaire"
                [(ngModel)]="editedRequest.comment">
              </textarea>
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button class="button" (click)="closeEditModal()">Annuler</button>
        <button class="button is-primary" (click)="onEditSubmit()">Sauvegarder</button>
      </footer>
    </div>
  </div>
</div>