<div class="replenishment-page">
  <div class="action-buttons">
    <button class="button add-button" (click)="openFormModal()">
      <span class="emoji">‚ú®</span>
      <span>Cr√©er une nouvelle demande</span>
    </button>
  </div>
  
  @if (isLoading) {
    <div class="loader-overlay">
      <div class="loader"></div>
    </div>
  } @else {
    <div class="requests-history-container">
      <div class="table-controls">
        <input 
          type="text" 
          placeholder="Rechercher par ID ou produit..." 
          class="search-bar" 
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >

        <select 
          class="filter-select"
          [(ngModel)]="selectedStatus"
          (change)="applyFilters()"
        >
          <option value="all">Tous les statuts</option>
          <option value="en_attente">En attente</option>
          <option value="approuve">Approuv√©e</option>
          <option value="rejete">Rejet√©e</option>
        </select>
      </div>

      <table class="requests-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date de demande</th>
            <th>Nombre de produits</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (request of paginatedRequests; track request.id) {
            <tr (click)="openRequestDetails(request)">
              <td>{{ request.id }}</td>
              <td>{{ request.created_at | date: 'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ request.items.length }}</td>
              <td class="status-cell" [class]="getStatusClass(request.status)">
                <span>{{ getReadableStatus(request.status) }}</span>
              </td>
              <td class="actions-cell">
                <button class="action-button" (click)="$event.stopPropagation(); editRequest(request)">
                  <span class="emoji">‚úèÔ∏è</span>
                </button>
                <button class="action-button" (click)="$event.stopPropagation(); deleteRequest(request.id)">
                  <span class="emoji">üóëÔ∏è</span>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="empty-state-cell">
                <div class="empty-state">
                  <span class="emoji">ü§∑</span>
                  <p>Aucune demande ne correspond √† vos filtres.</p>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      @if (totalPages > 1) {
        <div class="pagination">
          <button 
            class="page-link" 
            [disabled]="currentPage === 1" 
            (click)="onPageChange(currentPage - 1)">
            Pr√©c√©dent
          </button>
          @for (page of [].constructor(totalPages); track $index) {
            <button 
              class="page-link" 
              [class.active]="currentPage === $index + 1" 
              (click)="onPageChange($index + 1)">
              {{ $index + 1 }}
            </button>
          }
          <button 
            class="page-link" 
            [disabled]="currentPage === totalPages" 
            (click)="onPageChange(currentPage + 1)">
            Suivant
          </button>
        </div>
      }
    </div>
  }
</div>

<div class="modal-overlay" [class.show]="isFormModalOpen">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Cr√©er une nouvelle demande</h2>
      <button class="close-button" (click)="closeFormModal()">
        <span class="emoji">‚ùå</span>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="submitNewRequest()">
        <div class="form-group">
          <label for="product">Produit</label>
          <select 
            id="product" 
            name="product" 
            class="form-control" 
            [(ngModel)]="newRequestForm.product_id"
            required
          >
            <option value="" disabled>S√©lectionner un produit</option>
            @for (product of products; track product.id) {
              <option [value]="product.id">{{ product.name }} (Stock: {{ product.stock_quantity }})</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="quantity">Quantit√© demand√©e</label>
          <input 
            type="number" 
            id="quantity" 
            name="quantity" 
            class="form-control" 
            [(ngModel)]="newRequestForm.requested_quantity" 
            min="1"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="priority">Priorit√©</label>
          <select 
            id="priority" 
            name="priority" 
            class="form-control" 
            [(ngModel)]="newRequestForm.priority"
            required
          >
            @for (p of priorities; track p) {
              <option [value]="p">{{ p }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="comment">Commentaire</label>
          <textarea 
            id="comment" 
            name="comment" 
            class="form-control" 
            [(ngModel)]="newRequestForm.comment"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="closeFormModal()">Annuler</button>
          <button type="submit" class="submit-button">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>
</div>